name: Docker Compose Build and Push

on:
  push:
    branches:
      - master

permissions:
  contents: write
  packages: write
  deployments: write

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: run docker-compose
      uses: sudo-bot/action-docker-compose@latest
      with:
        # https://docs.docker.com/compose/reference/overview/
        cli-args: "up --build"
        
    - name: Login to DockerHub
      uses: docker/login-action@v1 
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Get short SHA
      id: get_sha
      run: echo "::set-output name=sha::$(git rev-parse --short HEAD)"

    - name: Create GitHub Release
      if: success()
      run: |
        gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
        VERSION="1.0.0+${{ steps.get_sha.outputs.sha }}"
        gh release create $VERSION \
          --title "Release $VERSION" \
          --notes "Auto-generated release from GitHub Actions."
